<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EduMap â€” ì—ë“€ë§µ (Kakao)</title>

<!-- Chart.js (ê°„ë‹¨ ë¹„êµ ì°¨íŠ¸) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{--accent:#2b7cff;--muted:#6b7280;--card:#fff;--bg:#f4f6fb}
  html,body,#app{height:100%;margin:0;font-family:Noto Sans KR,system-ui;background:var(--bg)}
  .app{display:grid;grid-template-columns:360px 1fr;gap:14px;padding:14px}
  .sidebar{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(30,41,59,0.06);overflow:auto}
  .logo{font-weight:700;color:var(--accent);font-size:18px}
  .search{display:flex;gap:8px;margin-top:8px}
  .search input{flex:1;padding:8px;border-radius:8px;border:1px solid #e6eefb}
  .btn{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
  .card{background:var(--card);padding:12px;border-radius:10px;margin-top:12px}
  #map{height:78vh;border-radius:12px;box-shadow:0 6px 18px rgba(30,41,59,0.06)}
  .controls{display:flex;gap:8px;align-items:center}
  .form-row{display:flex;gap:8px;margin-top:8px}
  .form-row input, .form-row select, textarea{padding:8px;border-radius:8px;border:1px solid #eef2ff;width:100%}
  .list{max-height:24vh;overflow:auto;margin-top:8px}
  .list .item{display:flex;justify-content:space-between;padding:8px;border-radius:8px;border:1px solid #f1f5f9;background:#fff;margin-bottom:8px}
  footer{font-size:12px;color:var(--muted);margin-top:8px}
  @media(max-width:960px){.app{grid-template-columns:1fr;grid-auto-rows:auto 1fr} #map{height:56vh}}
</style>
</head>
<body>
  <div id="app" class="app">
    <aside class="sidebar">
      <div>
        <div class="logo">EduMap Â· ì—ë“€ë§µ</div>
        <div style="font-size:12px;color:var(--muted)">ì§€ë„ ìœ„ì—ì„œ êµìœ¡ ê¸°íšŒë¥¼ í‰ë“±í•˜ê²Œ â€” ê³µê³µ/ë¬´ë£Œ ê°•ì¢Œì™€ í•™ì› ì •ë³´ë¥¼ ë¹„êµí•˜ì„¸ìš”.</div>
      </div>

      <div class="card">
        <div style="font-weight:600">ê²€ìƒ‰ / í•„í„°</div>
        <div class="search">
          <input id="q" placeholder="ì§€ì—­ëª… ë˜ëŠ” ê³¼ëª© ì…ë ¥ (ì˜ˆ: ê°•ë‚¨êµ¬ ìˆ˜í•™)">
          <button id="searchBtn" class="btn">ê²€ìƒ‰</button>
        </div>
        <div class="form-row">
          <select id="subjectFilter"><option value="">ê³¼ëª© ì „ì²´</option><option>ìˆ˜í•™</option><option>ì˜ì–´</option><option>ê³¼í•™</option><option>ì½”ë”©</option></select>
          <select id="priceFilter"><option value="">ê°€ê²©</option><option value="free">ë¬´ë£Œ</option><option value="budget">&lt;50,000</option><option value="mid">&lt;150,000</option><option value="high">&gt;=150,000</option></select>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:600">ë“±ë¡ / ìˆ˜ì • (ë¡œì»¬ ì €ì¥)</div>
        </div>
        <div style="font-size:13px;color:var(--muted);margin-top:6px">ëˆ„êµ¬ë‚˜ ì•±ì—ì„œ í•™ì›/í”„ë¡œê·¸ë¨ì„ ë“±ë¡í•˜ê³  í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ëŠ” ë¸Œë¼ìš°ì € localStorageì— ì €ì¥)</div>

        <div style="margin-top:8px">
          <input id="name" placeholder="ê¸°ê´€ëª… (ì˜ˆ: â—‹â—‹í•™ì›)">
          <div class="form-row" style="margin-top:8px">
            <input id="addr" placeholder="ì£¼ì†Œ (ë„ë¡œëª…)">
            <input id="subject" placeholder="ì£¼ìš” ê³¼ëª© (ì½¤ë§ˆë¡œ êµ¬ë¶„)">
          </div>
          <div class="form-row" style="margin-top:8px">
            <input id="fee" placeholder="ì›” í‰ê·  ìˆ˜ê°•ë£Œ (ìˆ«ì, ì› ë‹¨ìœ„ ì…ë ¥)"/>
            <input id="lat" placeholder="ìœ„ë„ (ì˜ˆ: 37.5665)"/>
            <input id="lng" placeholder="ê²½ë„ (ì˜ˆ: 126.9780)"/>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="addBtn" class="btn">ë“±ë¡</button>
            <button id="clearLocal" style="background:#f3f4f6;border:none;padding:8px;border-radius:8px;">ë¡œì»¬ ì´ˆê¸°í™”</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:600">ê²€ìƒ‰ ê²°ê³¼</div>
        <div class="list" id="resultList"></div>
        <footer>ì´ˆê¸° ë°ì´í„°ëŠ” ê³µê³µë°ì´í„°(ì„œìš¸Â·ê²½ê¸°Â·êµìœ¡ë¶€ ë“±)ì—ì„œ ì‹œë„í•œ ìë™ ë¡œë“œ ì‹œë„ í›„, ì‹¤íŒ¨í•˜ë©´ ìƒ˜í”Œ ë°ì´í„°ë¡œ ë™ì‘í•©ë‹ˆë‹¤.</footer>
      </div>
    </aside>

    <main>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">ì§€ë„ ë·°</div>
        <div style="display:flex;gap:8px">
          <label><input type="checkbox" id="showCircles" checked/> ì›í˜•í‘œì‹œ</label>
          <label><input type="checkbox" id="showMarkers" checked/> ë§ˆì»¤</label>
        </div>
      </div>
      <div id="map"></div>

      <div style="display:flex;gap:12px;margin-top:12px">
        <div class="card" style="flex:1">
          <div style="font-weight:600">ì§€ì—­ í†µê³„</div>
          <div id="regionStats" style="margin-top:8px;color:var(--muted)">ë§ˆì»¤ í´ë¦­ ì‹œ í†µê³„ í‘œì‹œ</div>
        </div>
        <div class="card" style="width:340px">
          <div style="font-weight:600">ì§€ì—­ ë¹„êµ</div>
          <div style="margin-top:8px">
            <input id="regA" placeholder="ì§€ì—­ A (ì˜ˆ: ì¢…ë¡œêµ¬)"/>
            <input id="regB" placeholder="ì§€ì—­ B (ì˜ˆ: ê°•ë‚¨êµ¬)" style="margin-top:8px"/>
            <button id="compareBtn" class="btn" style="margin-top:8px">ë¹„êµ</button>
            <canvas id="compChart" height="140" style="margin-top:8px"></canvas>
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
/* ================== ì„¤ì •(ìˆ˜ì •í¬ì¸íŠ¸) ==================
   - ì¹´ì¹´ì˜¤ ì•±í‚¤ëŠ” ì•„ë˜ì— ì´ë¯¸ ë°˜ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
   - ì‹¤ì œ ê³µê³µë°ì´í„° APIë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ (data.go.kr ë“±) ì„œë²„ì‚¬ì´ë“œì—ì„œ APIí‚¤ë¥¼ ìˆ¨ê¸°ê³  í”„ë¡ì‹œí•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
==================================================== */

/* === ì´ë¯¸ ì ìš©ëœ Kakao App Key (ìš”ì²­í•˜ì‹  ê°’) === */
const KAKAO_APPKEY = '7ce0e2d94a1930e724497b939562a74f';

/* === ì‹¤ë°ì´í„° ì—”ë“œí¬ì¸íŠ¸(ì˜µì…˜) ===
   ì˜ˆ: ì„œìš¸ ì—´ë¦°ë°ì´í„° CSV/JSON URL ë˜ëŠ” data.go.kr OpenAPI ì—”ë“œí¬ì¸íŠ¸
   ë§Œì•½ ì„œë²„ì—ì„œ ì§ì ‘ OpenAPI í‚¤ë¥¼ ë³´ê´€í•˜ì§€ ì•Šìœ¼ë©´ ë¸Œë¼ìš°ì €ì—ì„œ ë°”ë¡œ í˜¸ì¶œ ì‹œ CORS/ì¸ì¦ ì—ëŸ¬ê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ.
   ì•„ë˜ ì˜ˆì‹œëŠ” ì‹œë„í•´ë³´ê³  ì‹¤íŒ¨í•˜ë©´ í´ë°±(ìƒ˜í”Œ ë°ì´í„°) í•©ë‹ˆë‹¤.
*/
const PUBLIC_DATA_SOURCES = [
  // ì„œìš¸ ì—´ë¦°ë°ì´í„° í•™ì› êµìŠµì†Œì •ë³´(ì›¹í˜ì´ì§€ ê¸°ë°˜): íŒŒì¼ ë‹¤ìš´ë¡œë“œ/CSV URLì´ í•„ìš”.
  // ì˜ˆ: 'https://data.seoul.go.kr/.../seoul_academy.csv'  (ì‹¤ì œ CSV URLë¡œ êµì²´ ê°€ëŠ¥)
  // ê²½ê¸°ë„ OpenAPI ë“±ë„ ì—¬ê¸°ì— ì¶”ê°€ ê°€ëŠ¥
];

/* =================================================
   ê¸°ë³¸ ìƒ˜í”Œ ë°ì´í„° (ê³µê³µë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©)
   ì‹¤ì œ ì„œë¹„ìŠ¤ ì‹œëŠ” ì„œë²„ì—ì„œ ê³µê³µë°ì´í„°ë¥¼ ì •ì œí•˜ì—¬ ì „ë‹¬í•˜ì„¸ìš”.
=================================================*/
const SAMPLE = [
  { id: 's1', name: 'ê°•ë‚¨ ìˆ˜í•™ í•™ì› A', lat:37.4979, lng:127.0276, addr:'ê°•ë‚¨êµ¬ ì—­ì‚¼ë™', subjects:['ìˆ˜í•™'], fee:220000, source:'sample' },
  { id: 's2', name: 'ì¢…ë¡œ ì˜ì–´ ìŠ¤ì¿¨', lat:37.572, lng:126.979, addr:'ì¢…ë¡œêµ¬ ì¢…ë¡œ1ê°€', subjects:['ì˜ì–´'], fee:90000, source:'sample' },
  { id: 's3', name: 'ë…¸ì› í•™ìŠµì§€ì›ì„¼í„°', lat:37.6543, lng:127.0564, addr:'ë…¸ì›êµ¬ ìƒê³„ë™', subjects:['ìˆ˜í•™'], fee:70000, source:'sample' },
  { id: 's4', name: 'ë§ˆí¬ ì½”ë”© ìŠ¤í„°ë””', lat:37.5663, lng:126.9016, addr:'ë§ˆí¬êµ¬ í•©ì •ë™', subjects:['ì½”ë”©'], fee:85000, source:'sample' }
];

/* ============ ì•± ìƒíƒœ ============ */
const state = {
  map: null,
  markers: [],       // kakao.maps.Marker
  circles: [],       // kakao.maps.Circle
  data: [],          // combined data (public + local)
  localKey: 'edumap_local_entries',
  infoOverlay: null,
};

/* ============ ìœ í‹¸ ============ */
function uid(){ return 'id_' + Math.random().toString(36).slice(2,9); }
function fmtKRW(n){ if(!n && n!==0) return '-'; return n.toLocaleString() + 'ì›'; }
function subjectsToStr(arr){ return Array.isArray(arr) ? arr.join(', ') : (arr||''); }

/* ============ ë¡œì»¬ ì €ì¥ ê´€ë¦¬ (ì‚¬ìš©ì ë“±ë¡/í¸ì§‘ìš©) ============ */
function loadLocal(){
  try {
    const raw = localStorage.getItem(state.localKey);
    return raw ? JSON.parse(raw) : [];
  } catch(e){ console.error(e); return []; }
}
function saveLocal(list){
  localStorage.setItem(state.localKey, JSON.stringify(list));
}

/* ============ ì§€ë„ ì´ˆê¸°í™” ============ */
function loadKakao(){
  return new Promise((resolve)=>{
    if (window.kakao && kakao.maps) return resolve();
    const s = document.createElement('script');
    s.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=${KAKAO_APPKEY}&autoload=false`;
    s.onload = () => {
      kakao.maps.load(()=> resolve());
    };
    document.head.appendChild(s);
  });
}

async function init(){
  await loadKakao();
  const mapContainer = document.getElementById('map');
  state.map = new kakao.maps.Map(mapContainer, { center: new kakao.maps.LatLng(37.5665,126.9780), level: 7 });

  // ì¸í¬ì˜¤ë²„ë ˆì´ (ê³µìœ )
  state.infoOverlay = new kakao.maps.CustomOverlay({ yAnchor: 1.2 });

  // ë¨¼ì € ê³µê³µë°ì´í„° ì‹œë„ ë¡œë“œ -> ì‹¤íŒ¨ì‹œ ìƒ˜í”Œ ì‚¬ìš© -> + local entries
  await tryLoadPublicData();

  // load local saved entries
  const localEntries = loadLocal();
  // if local entries exist, ensure id present
  localEntries.forEach(e=>{ if(!e.id) e.id = uid(); });

  // combine
  state.data = [...state.data, ...localEntries];

  renderAll();

  // UI hooks
  document.getElementById('searchBtn').onclick = onSearch;
  document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter') onSearch(); });
  document.getElementById('addBtn').onclick = addEntryFromForm;
  document.getElementById('clearLocal').onclick = ()=>{ if(confirm('ë¡œì»¬ì— ì €ì¥ëœ ëª¨ë“  ì‚¬ìš©ì ë“±ë¡ ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?')){ localStorage.removeItem(state.localKey); location.reload(); } };
  document.getElementById('showCircles').onchange = e=> toggleCircles(e.target.checked);
  document.getElementById('showMarkers').onchange = e=> toggleMarkers(e.target.checked);
  document.getElementById('compareBtn').onclick = onCompare;
}

/* ============ ê³µê³µë°ì´í„° ë¡œë“œ ì‹œë„ (ë¸Œë¼ìš°ì € -> CORS/ì¸ì¦ ì œì•½ ìˆì„ ìˆ˜ ìˆìŒ) ============ */
async function tryLoadPublicData(){
  // ì‹œë„ 1: data.seoul.go.kr (íŒŒì¼ ë‹¤ìš´ë¡œë“œ URLì´ ëª…í™•í•˜ë©´ fetch ê°€ëŠ¥)
  // ì‹œë„ 2: data.go.kr OpenAPI (ëŒ€ê°œ ì¸ì¦í‚¤ í•„ìš”í•˜ë¯€ë¡œ ì„œë²„ í”„ë¡ì‹œ ê¶Œì¥)
  // í˜„ì¬ ë°ëª¨ëŠ” public fetch ì‹œë„ í›„ ì‹¤íŒ¨í•˜ë©´ SAMPLE ì‚¬ìš©.
  let loaded = false;

  // Example: attempt to fetch an example CSV/JSON URL (none provided by user).
  // If you have a direct CSV/JSON URL, add to PUBLIC_DATA_SOURCES array above.
  for (const url of PUBLIC_DATA_SOURCES){
    try {
      const res = await fetch(url);
      if(!res.ok) continue;
      // try parse as json or csv (simple)
      const text = await res.text();
      // if json:
      try {
        const json = JSON.parse(text);
        // transform json to our data shape if needed
        const transformed = transformPublicToInternal(json);
        state.data = state.data.concat(transformed);
        loaded = true;
        break;
      } catch(e){
        // try CSV simple parse (header,text)
        const rows = text.split('\n').map(r=>r.trim()).filter(Boolean);
        if (rows.length>1){
          const header = rows[0].split(',').map(h=>h.replace(/["']/g,'').trim());
          const items = rows.slice(1).map(r=>{
            const cols = r.split(',').map(c=>c.replace(/["']/g,'').trim());
            const obj = {};
            header.forEach((h,i)=> obj[h]=cols[i]||'');
            return obj;
          });
          const transformed = items.map((it,idx)=>({
            id: 'p_'+idx,
            name: it['ê¸°ê´€ëª…'] || it['í•™ì›ëª…'] || it['facility_nm'] || it['ì‹œì„¤ëª…'] || it.name || 'unknown',
            addr: it['ì£¼ì†Œ']||it['ì†Œì¬ì§€']||'',
            lat: parseFloat(it['lat']||it['ìœ„ë„']||it['WGS84_LAT'])||0,
            lng: parseFloat(it['lng']||it['ê²½ë„']||it['WGS84_LONG'])||0,
            fee: parseInt(it['ìˆ˜ê°•ë£Œ']||it['ìˆ˜ê°•ë£Œì •ë³´']||0)||0,
            subjects: (it['êµìŠµê³¼ì •ëª…']||it['ê³¼ëª©']||'').split('/').map(s=>s.trim()).filter(Boolean),
            source:'public'
          }));
          state.data = state.data.concat(transformed);
          loaded = true;
          break;
        }
      }
    } catch(e){
      console.warn('public source fetch failed', url, e);
      continue;
    }
  }

  if(!loaded){
    // fallback sample
    state.data = SAMPLE.slice();
  }
}

/* helper (ìƒ˜í”Œ ë³€í™˜ì) */
function transformPublicToInternal(json){ /* ì‚¬ìš©ì í™˜ê²½ì— ë§ê²Œ ë³€í™˜ êµ¬í˜„ ê°€ëŠ¥ */ return []; }

/* ============ ë Œë”ë§: ë§ˆì»¤/ì›í˜•/ëª©ë¡ ============ */
function renderAll(){
  clearMap();
  renderMarkersAndCircles(state.data);
  renderList(state.data);
}

function clearMap(){
  state.markers.forEach(m=>m.setMap(null));
  state.circles.forEach(c=>c.setMap(null));
  state.markers=[]; state.circles=[];
}

function renderMarkersAndCircles(list){
  list.forEach(item=>{
    if(!item.lat || !item.lng) return;
    // Marker
    const marker = new kakao.maps.Marker({
      position: new kakao.maps.LatLng(item.lat, item.lng),
      map: document.getElementById('showMarkers').checked ? state.map : null,
      title: item.name
    });
    marker.__itemId = item.id;
    kakao.maps.event.addListener(marker, 'click', ()=> onMarkerClick(item, marker));
    state.markers.push(marker);

    // Circle styled by fee
    const color = feeColor(item.fee);
    const circle = new kakao.maps.Circle({
      center: new kakao.maps.LatLng(item.lat, item.lng),
      radius: 500 + (Math.min(200000, item.fee||0) / 1000), // fee ë§ì„ìˆ˜ë¡ ë°˜ê²½ ì¦ê°€ (ì‹œê°í™”ìš©)
      strokeWeight: 2,
      strokeColor: color,
      strokeOpacity: 0.8,
      fillColor: color,
      fillOpacity: 0.25,
      map: document.getElementById('showCircles').checked ? state.map : null
    });
    state.circles.push(circle);
  });
}

function feeColor(fee){
  if(!fee) return '#2ecc71';
  if (fee >= 150000) return '#e74c3c';
  if (fee >= 80000)  return '#f39c12';
  return '#2ecc71';
}

function onMarkerClick(item, marker){
  const content = document.createElement('div');
  content.style.padding='10px';
  content.style.width='220px';
  content.innerHTML = `
    <div style="font-weight:700;margin-bottom:6px">${item.name}</div>
    <div style="font-size:13px;color:#333">ğŸ’¸ ${fmtKRW(item.fee)} <br/>ğŸ“ ${item.addr||'-'} <br/>ğŸ“š ${subjectsToStr(item.subjects)}</div>
    <div style="margin-top:8px;display:flex;gap:6px">
      <button id="edit_${item.id}" style="flex:1;padding:6px;border-radius:6px;border:none;background:#f3f4f6;cursor:pointer">í¸ì§‘</button>
      <button id="del_${item.id}" style="flex:1;padding:6px;border-radius:6px;border:none;background:#ffecec;cursor:pointer">ì‚­ì œ</button>
    </div>
  `;
  state.infoOverlay.setContent(content);
  state.infoOverlay.setPosition(marker.getPosition());
  state.infoOverlay.setMap(state.map);

  // ì´ë²¤íŠ¸ ìœ„ì„(ì§€ì—°)
  setTimeout(()=>{
    const eb = document.getElementById(`edit_${item.id}`);
    const db = document.getElementById(`del_${item.id}`);
    if(eb) eb.onclick = ()=> beginEdit(item);
    if(db) db.onclick = ()=> deleteEntry(item.id);
  },50);
}

/* ============ ëª©ë¡ ë Œë”ë§ ============ */
function renderList(list){
  const cont = document.getElementById('resultList');
  cont.innerHTML = '';
  if(!list.length) { cont.innerHTML = '<div style="color:#999">ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  list.forEach(it=>{
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `<div>
      <div style="font-weight:600">${it.name}</div>
      <div style="font-size:12px;color:#666">${it.addr||'-'} Â· ${subjectsToStr(it.subjects)} Â· ${fmtKRW(it.fee)}</div>
    </div>
    <div style="display:flex;flex-direction:column;gap:6px">
      <button style="padding:6px;border-radius:6px;border:none;background:#f3f4f6;cursor:pointer" onclick="focusOn('${it.id}')">ì§€ë„ì—ì„œ ë³´ê¸°</button>
      <button style="padding:6px;border-radius:6px;border:none;background:#fff0f0;color:#b32;cursor:pointer" onclick="deleteEntry('${it.id}')">ì‚­ì œ</button>
    </div>`;
    cont.appendChild(el);
  });
}

/* ============ ê²€ìƒ‰ ============ */
function onSearch(){
  const q = (document.getElementById('q').value||'').trim().toLowerCase();
  const subj = (document.getElementById('subjectFilter').value||'').trim();
  const price = (document.getElementById('priceFilter').value||'').trim();

  let res = state.data.filter(d=>{
    let ok = true;
    if (q) ok = ok && ((d.name||'').toLowerCase().includes(q) || (d.addr||'').toLowerCase().includes(q) || (subjectsToStr(d.subjects)||'').toLowerCase().includes(q));
    if (subj) ok = ok && (Array.isArray(d.subjects) ? d.subjects.includes(subj) : (d.subjects||'').includes(subj));
    if (price){
      if (price === 'free') ok = ok && (!d.fee || d.fee===0);
      if (price === 'budget') ok = ok && (d.fee && d.fee < 50000);
      if (price === 'mid') ok = ok && (d.fee && d.fee < 150000);
      if (price === 'high') ok = ok && (d.fee && d.fee >= 150000);
    }
    return ok;
  });

  renderList(res);
  if (res.length>0 && res[0].lat && res[0].lng){
    state.map.panTo(new kakao.maps.LatLng(res[0].lat,res[0].lng));
    state.map.setLevel(5);
  }
}

/* ============ ë“±ë¡ / í¸ì§‘ / ì‚­ì œ ============ */
function addEntryFromForm(){
  const name = document.getElementById('name').value.trim();
  if(!name) return alert('ê¸°ê´€ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
  const addr = document.getElementById('addr').value.trim();
  const subjects = (document.getElementById('subject').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const fee = parseInt((document.getElementById('fee').value||'').replace(/[^0-9]/g,'')) || 0;
  const lat = parseFloat(document.getElementById('lat').value) || null;
  const lng = parseFloat(document.getElementById('lng').value) || null;

  const entry = { id: uid(), name, addr, subjects, fee, lat, lng, source:'user' };

  // push to localStorage
  const local = loadLocal();
  local.push(entry);
  saveLocal(local);

  // add to state and render
  state.data.push(entry);
  renderAll();

  // clear form
  document.getElementById('name').value=''; document.getElementById('addr').value=''; document.getElementById('subject').value=''; document.getElementById('fee').value=''; document.getElementById('lat').value=''; document.getElementById('lng').value='';
  alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. (ë¡œì»¬ ì €ì¥) â€” ë°±ì—”ë“œ ì—°ë™ ì‹œ ì„œë²„ DBì— ì €ì¥ë˜ë„ë¡ ë³€ê²½í•˜ì„¸ìš”.');
}

function beginEdit(item){
  // populate form with item data; when user presses ë“±ë¡, we'll push new entry (simple approach)
  document.getElementById('name').value = item.name || '';
  document.getElementById('addr').value = item.addr || '';
  document.getElementById('subject').value = (item.subjects||[]).join(',');
  document.getElementById('fee').value = item.fee || '';
  document.getElementById('lat').value = item.lat || '';
  document.getElementById('lng').value = item.lng || '';
  // remove the old entry on save to emulate edit (or you can implement an edit mode)
  deleteEntry(item.id, /*noConfirm=*/true);
  window.scrollTo({top:0,behavior:'smooth'});
}

function deleteEntry(id, noConfirm){
  if(!noConfirm && !confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  // remove from state.data and localStorage if exists
  state.data = state.data.filter(d=>d.id !== id);
  const local = loadLocal().filter(d=>d.id !== id);
  saveLocal(local);
  renderAll();
}

/* ============ í¬ì»¤ìŠ¤ on map ============ */
function focusOn(id){
  const it = state.data.find(d=>d.id===id);
  if(!it) return alert('í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  if(it.lat && it.lng){
    state.map.panTo(new kakao.maps.LatLng(it.lat,it.lng));
    state.map.setLevel(4);
    // open overlay: find marker
    const marker = state.markers.find(m => m.__itemId === id);
    if(marker) onMarkerClick(it, marker);
  } else {
    alert('ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
  }
}

/* ============ í† ê¸€ í‘œì‹œ ============ */
function toggleCircles(on){
  state.circles.forEach(c=> c.setMap(on ? state.map : null));
}
function toggleMarkers(on){
  state.markers.forEach(m=> m.setMap(on ? state.map : null));
}

/* ============ ë¹„êµ ì°¨íŠ¸ ============ */
function onCompare(){
  const a = (document.getElementById('regA').value||'').trim();
  const b = (document.getElementById('regB').value||'').trim();
  if(!a||!b) return alert('ë‘ ì§€ì—­ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì¢…ë¡œêµ¬, ê°•ë‚¨êµ¬)');
  const ra = findByRegionName(a);
  const rb = findByRegionName(b);
  if(!ra || !rb) return alert('ì…ë ¥í•œ ì§€ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì •í™•í•œ í–‰ì •êµ¬/êµ¬ëª… í•„ìš”í•  ìˆ˜ ìˆìŒ)');
  const ctx = document.getElementById('compChart').getContext('2d');
  if(window._cmp) window._cmp.destroy();
  window._cmp = new Chart(ctx, {
    type:'bar',
    data:{
      labels:['í‰ê·  ìˆ˜ê°•ë£Œ','ë“±ë¡ í•™ì› ìˆ˜(ë°ëª¨)'],
      datasets:[
        {label:ra.name, data:[ra.fee||0, countByRegion(ra.name)], backgroundColor:'rgba(43,124,255,0.7)'},
        {label:rb.name, data:[rb.fee||0, countByRegion(rb.name)], backgroundColor:'rgba(243,156,18,0.7)'}
      ]
    },
    options:{scales:{y:{beginAtZero:true}}}
  });
}

function findByRegionName(name){
  // try to find first entry whose addr or name contains the region name
  return state.data.find(d=> (d.addr||'').includes(name) || (d.name||'').includes(name) || d.name.toLowerCase().includes(name.toLowerCase()));
}
function countByRegion(name){
  const term = name.split(' ')[0];
  return state.data.filter(d=> (d.addr||'').includes(term) || (d.name||'').includes(term) ).length;
}

/* ============ ì‹¤í–‰ ============ */
init();

/* ============ ê°œë°œ/ë°°í¬ ë…¸íŠ¸ ============
1) ê³µê³µë°ì´í„° ì—°ë™:
   - data.go.kr (êµìœ¡ë¶€/ì‹œë„êµìœ¡ì²­), ì„œìš¸ ì—´ë¦°ë°ì´í„°(data.seoul.go.kr), ê²½ê¸°ë„ open API ë“±ì—ì„œ í•™ì› ìœ„ì¹˜Â·ìˆ˜ê°•ë£Œ ë°ì´í„°ë¥¼ ì œê³µí•¨.
   - ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ í˜¸ì¶œí•˜ë©´ CORSë‚˜ ì¸ì¦ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥ â†’ ì•ˆì •ì ìœ¼ë¡œ í•˜ë ¤ë©´ ë°±ì—”ë“œ(Express/Firebase ë“±)ì—ì„œ OpenAPI í‚¤ë¡œ fetchí•œ ë’¤ í”„ë¡ íŠ¸ì— ì „ë‹¬í•˜ì„¸ìš”.
   - ê´€ë ¨ ë°ì´í„°ì…‹ ì˜ˆ: "ì„œìš¸ì‹œ í•™ì› êµìŠµì†Œì •ë³´", "ê²½ê¸°ë„_í•™ì› í˜„í™©", "í•™ì›êµìŠµì†Œì •ë³´(êµìœ¡ë¶€/NEIS)". (ì•± ê¸°íšì„œ/ë°ì´í„° ì¶œì²˜ëŠ” ì•„ë˜ì— ì²¨ë¶€)

2) ë°±ì—”ë“œ ì „í™˜ í¬ì¸íŠ¸(ê°„ë‹¨):
   - POST /api/entry      : ì‚¬ìš©ì ë“±ë¡ (DB ì €ì¥)
   - GET  /api/regions    : ì •ì œëœ í•™ì›/í”„ë¡œê·¸ë¨ ëª©ë¡ (ìœ„ë„/ê²½ë„ í¬í•¨)
   - PUT  /api/entry/:id  : í¸ì§‘
   - DELETE /api/entry/:id: ì‚­ì œ
   - ì„œë²„ì—ì„œ ì •ê¸°ì ìœ¼ë¡œ ê³µê³µë°ì´í„° íŒŒì‹±/ì •ì œí•´ DBì— ì ì¬í•˜ë©´ ì„œë¹„ìŠ¤ ì•ˆì •í™” ê°€ëŠ¥

3) ì¶”ê°€ ê°œì„ :
   - ì‚¬ìš©ì ì¸ì¦, ì‹ ê³ /ì‹ ë¢°ë„ ì‹œìŠ¤í…œ, ì‚¬ì§„ ì—…ë¡œë“œ, íŒŒì¼(ë…¸íŠ¸) ê³µìœ  ë“±
   - Kakao ì§€ë„ í´ëŸ¬ìŠ¤í„°ëŸ¬, ë ˆì´ì–´(ë¬´ë£Œê°•ì¢Œ ë ˆì´ì–´), ê°•ì¢Œ ìº˜ë¦°ë” ì—°ë™

=========================================== */
</script>
</body>
</html>
